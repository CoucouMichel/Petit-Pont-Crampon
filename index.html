<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Petit Pont Crampon</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="global-container">
        <div class="fixed-header">
    <h1>Petit Pont Crampon</h1>
    <p>Démasquez le joueur mystère en trouvant les pays et les clubs dans lesquels il a joué !</p>
    <div class="input-container" style="position: relative;">
                <input 
                    type="text" 
                    id="guess-input" 
                    placeholder="Tapez un pays, un club ou le nom du joueur mystère" 
                    autocomplete="off"
                >
                <ul id="autocomplete-list" class="autocomplete-suggestions"></ul>
                <div id="guess-feedback"></div>
            </div>
            
            <p id="attempts">Tentatives : 0</p>
            <p id="feedback"></p>
             <!-- Button Container -->
        <div class="button-container">
            <button class="button" id="hint-button">Indice</button>
            <button class="button" id="career-button">Carrière</button>
            <button class="button" id="answer-button">Réponse</button>
            </div>
        </div>

        <div class="container">
            <h2>Carrière du joueur</h2>
            <table id="career-table">
                <thead>
                    <tr>
                        <th>Années</th>
                        <th>Club</th>
                        <th>Pays</th>
                    </tr>
                </thead>
                <tbody id="career-table-body">
                    <!-- Les lignes du tableau seront ajoutées dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>
</body>

<script>
      let selectedPlayer;
let attempts = 0;
let revealPlayerOnce = false;

const indiceButton = document.getElementById("indiceButton");
const carriereButton = document.getElementById("carriereButton");
const reponseButton = document.getElementById("reponseButton");

async function loadPlayerStats() {
    const response = await fetch('./players_stats.json');
    return response.json();
}

async function loadClubsCountries() {
    const response = await fetch('./clubscountries.json');
    return response.json();
}

async function selectRandomPlayer() {
    const playersData = await loadPlayerStats();
    const players = Object.keys(playersData);
    selectedPlayer = players[Math.floor(Math.random() * players.length)];
    return playersData[selectedPlayer];
}

async function loadCountryMapping() {
    try {
        const response = await fetch('./country2letters.json');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    } catch (error) {
        console.error("Error loading country mapping:", error);
        return {};
    }
}

async function loadClubNameMapping() {
    try {
        const response = await fetch('./clubNameMapping.json');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    } catch (error) {
        console.error("Error loading club name mapping:", error);
        return {};
    }
}

async function loadClubLogos() {
    try {
        const response = await fetch('./clubLogos.json');
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return await response.json();
    } catch (error) {
        console.error("Error loading club logos:", error);
        return {};
    }
}

async function displayPlayerStats() {
    const clubNameMapping = await loadClubNameMapping();
    const countryMapping = await loadCountryMapping();
    const clubLogos = await loadClubLogos();
    const stats = await selectRandomPlayer();

    const tableBody = document.getElementById('career-table-body');
    tableBody.innerHTML = '';

    if (!Array.isArray(stats)) {
        console.error("Expected stats to be an array, but got:", stats);
        return;
    }

    stats.forEach(stat => {
        if (stat.season && stat.season.toLowerCase().includes("season")) return;

        const fullCountryName = countryMapping[stat.country] || stat.country;
        const flagUrl = `https://flagcdn.com/w20/${stat.country}.png`;
        const formattedClubName = clubNameMapping[stat.team] || stat.team;
        const logoUrl = clubLogos[stat.team] || '';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${stat.season}</td>
            <td class="hidden" data-club="${stat.team}">
                <img src="${logoUrl}" alt="${formattedClubName} logo" style="width: 20px; height: 20px; margin-right: 5px;"> 
                ${formattedClubName}
            </td>
            <td class="hidden" data-country="${fullCountryName}">
                <img src="${flagUrl}" alt="${fullCountryName} flag" style="width: 20px; height: 15px; margin-right: 5px; vertical-align: middle;"> 
                ${fullCountryName}
            </td>
        `;
        tableBody.appendChild(row);
    });
}

async function showSuggestions(value) {
    const autocompleteList = document.getElementById("autocomplete-list");
    autocompleteList.innerHTML = "";

    if (value.trim() === "") return;

    try {
        const data = await loadClubsCountries();
        const suggestions = new Set();

        for (let club in data) {
            const country = data[club];
            if (club.toLowerCase().includes(value.toLowerCase())) {
                suggestions.add(club);
            }
            if (country.toLowerCase().includes(value.toLowerCase())) {
                suggestions.add(country);
            }
        }

        const sortedSuggestions = Array.from(suggestions).sort();

        sortedSuggestions.forEach(suggestion => {
            const listItem = document.createElement("li");
            listItem.textContent = suggestion;
            listItem.classList.add("suggestion-item");
            listItem.addEventListener("click", () => {
                document.getElementById("guess-input").value = "";
                autocompleteList.innerHTML = "";
                checkAnswer(suggestion);
            });
            autocompleteList.appendChild(listItem);
        });

    } catch (error) {
        console.error("Erreur lors du chargement des suggestions :", error);
    }
}

async function checkAnswer(input) {
    const answer = input.trim().toLowerCase();
    const feedback = document.getElementById("feedback");
    const countryMapping = await loadCountryMapping();
    const reverseMapping = Object.fromEntries(
        Object.entries(countryMapping).map(([abbr, fullName]) => [fullName.toLowerCase(), abbr.toLowerCase()])
    );
    let isCorrect = false;

    if (answer === selectedPlayer.toLowerCase()) {
        feedback.textContent = `Bingo ! Vous avez trouvé le joueur : ${selectedPlayer}`;
        feedback.style.color = "green";
        revealAllCells();
        isCorrect = true;
    } else {
        feedback.textContent = '';
        attempts++;
        document.getElementById("attempts").textContent = `Tentatives : ${attempts}`;
    }

    const cells = document.querySelectorAll('td[data-country], td[data-club]');
    cells.forEach(cell => {
        const cellCountry = cell.getAttribute('data-country')?.toLowerCase();
        const cellClub = cell.getAttribute('data-club')?.toLowerCase();

        if (cellCountry === answer || reverseMapping[cellCountry] === answer || cellClub === answer) {
            revealText(cell);
            isCorrect = true;
        }
    });
    blinkInput(isCorrect);
}

function blinkInput(isCorrect) {
    const inputField = document.getElementById("guess-input");
    if (isCorrect) {
        inputField.classList.add("blink-green");
    } else {
        inputField.classList.add("blink-red");
    }
    setTimeout(() => {
        inputField.classList.remove("blink-green", "blink-red");
    }, 500);
}

function revealText(cell) {
    cell.classList.add('visible');
}

function revealAllCells() {
    const allCells = document.querySelectorAll('td');
    allCells.forEach(cell => {
        cell.classList.add('visible');
    });
}

const input = document.getElementById("guess-input");
input.addEventListener("input", () => showSuggestions(input.value));
input.addEventListener("keyup", (event) => {
    if (event.key === "Enter") {
        checkAnswer(input.value);
        input.value = "";
        document.getElementById("autocomplete-list").innerHTML = "";
    }
});

// Event listeners for the Indice button
indiceButton.addEventListener("click", function () {
    revealRandomClue();
});

// Event listeners for the Carrière button
carriereButton.addEventListener("click", function () {
    revealAll();
});

// Event listeners for the Réponse button
reponseButton.addEventListener("click", function () {
    revealAll();
    revealPlayer();
});

function revealRandomClue() {
    if (!selectedPlayer) return;

    const columnsToReveal = [1, 2];
    const randomColumnIndex = Math.floor(Math.random() * columnsToReveal.length);
    const columnIndex = columnsToReveal[randomColumnIndex];

    const allCells = document.querySelectorAll('#career-table-body tr td:nth-child(' + (columnIndex + 1) + ')');

    allCells.forEach(cell => {
        cell.classList.add('visible');
    });

    indiceButton.disabled = true
    indiceButton.classList.add("button-disabled")
}


function revealAll() {
        if (!selectedPlayer) return;
    document.querySelectorAll('#career-table-body tr td').forEach(cell => {
            cell.classList.add('visible')
    })
    carriereButton.disabled = true
    carriereButton.classList.add("button-disabled")
}

function revealPlayer() {
    if (!selectedPlayer) return;

    if (revealPlayerOnce) {
        return
    }

    const nameCell = document.querySelector('table tr td:first-child');
        
    const playerRow = document.querySelector('#career-table-body tr:first-child');
    const firstCell = playerRow.querySelector('td:first-child')

    firstCell.classList.add('visible')


    revealPlayerOnce = true
    reponseButton.disabled = true
    reponseButton.classList.add("button-disabled")
}

displayPlayerStats();
    </script>
</body>
</html>
